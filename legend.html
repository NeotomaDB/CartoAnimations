<!DOCTYPE html>
<html>

<head>
    <title>Range Mapper | North America</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://libs.cartocdn.com/carto-vl/v1.4.1/carto-vl.min.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://libs.cartocdn.com/carto-vl/v1.0.0/carto-vl.min.js"></script>
    <link href="https://carto.com/developers/carto-vl/examples/maps/style.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

<!-- Map div -->
<div id="map"></div>

<!-- dropdown selector -->
<!-- <div id="wraper-dropdown-selector">
  <select id="js-dropdown-selector">
      <option value="northamerica" selected>North America</option>
      <option value="europe">Europe</option>
  </select>
</div> -->

<style>
    #wraper-dropdown-selector {
        background-color: #d2eaef;
        opacity: 0.8;
        position: absolute;
        top: 10px;
        left: 30%;
        width: auto;
        height: auto;
        padding: 10px;
        display: block;
        z-index: 9000;

    }

    #js-dropdown-selector input {
        width: 200px;
    }
</style>

<!-- Legend -->
<section class="toolbox">
    <div class="box" id="legend-box">
        <header id="legend-head-text">
        <div>Percent Abundance</div>
        </header>
        <!-- Add legend data -->
        <!-- <section class="legend-section"> -->
        <div id="controls" class="legend-controls">
            <ul id="content" class="legend-content"> </ul>
        </div>
        <div id="logo-div"> <img id="neotoma-logo" src="images/neotoma.jpeg" alt="neotoma">
        </div>
    </div>
</section>


<div id="menu">
    <header id="legend-head-text">Taxa</header>
</div>

<aside class=toolbox id="animation-toolbox">
  <div class="box" id="animation-box">
    <header>
      <h1 id="animation-header"> Range Mapper
        <button id="js-play-button"><img src="images/play.png"></button>
        <button id="js-pause-button"><img src="images/pause.png"></button></h1>
    </header>
    <section id="animation-section">
      <p class="animation-rangebar">
      Progress: <input type="range" id="js-progress-range" min="-18000" max="0" step="500"></p>
    </section>
    <section id="animation-section">
      <p class="animation-rangebar">
      Current: <span id="js-current-time" class="open-sans"></span></p>
    </section>
    <section id="animation-section">
      <p class="animation-rangebar">
      Duration: <input type="range" id="js-duration-range" min="1" max="42" step="2">
    </section>
</aside>


<script>
  const map = new mapboxgl.Map({
      container: 'map',
      style: carto.basemaps.positron,
      center: [-96, 41],
      zoom: 3
  });
  const nav = new mapboxgl.NavigationControl({
      showCompass: false
  });
  carto.setDefaultAuth({
      username: 'widell',
      apiKey: '7de5ebf57ee0f31ed45302fb9c0b3a90723921ae'
  });


      const pollenSource = new carto.source.Dataset("cartoinput_na_3");
      const iceSource = new carto.source.Dataset('icesheets');

// function updateSource() {
//
// const selector = document.getElementById("js-dropdown-selector");
//   console.log(selector);
// // change sql query with dropdown value
// selector.on('change', function(e) {
//   let value = e.target.value;
//
//   if (value == 'northamerica') {
//     carto.source.Dataset(`cartoinput_na_3`);
//   }
//   else if (value == 'europe') {
//       carto.source.Dataset(`cartoinputeuro`);
//   }
// });
// https://aegeorge2.carto.com/api/v2/sql?q=SELECT+column_name+FROM+information_schema.columns+WHERE+table_name+=+%27cartoinput_eur_v2%27&api_key=2b8175051e465979cce3424b18b49846d1461e48+AND+


    var toggleableIds = ['Alnus', 'Ambrosia', 'Cyperaceae', 'Fagus', 'Picea', 'Pinus', 'Poaceae', 'Quercus', 'Tsuga', 'Ulmus'];
    var taxaColumns1 = ['$alnus', '$ambrosia', '$cyperaceae', '$fagus', '$picea', '$pinus', '$poaceae', '$quercus', '$tsuga', '$ulmus'];
    var taxaColumns = ['alnus', 'ambrosia', 'cyperaceae', 'fagus', 'picea', 'pinus', 'poaceae', 'quercus', 'tsuga', 'ulmus'];
    var taxaColors = ['#990033', '#FF5733', '#FFC300', '#336699', '#339999', '#C7003A', '#FF8D19', '#ADD55C', '#511849', '#009973'];
    var taxaViz = []
    var taxaLayers = []
//
// for (var i = 0; i < taxaColumns.length; ++i)
//     taxaVizNames[i] = taxaColumns[i] + "Viz"


    for (var i = 0; i < taxaColumns.length; ++i) {
        taxaColumn = '$' + taxaColumns[i]
        taxaColor  = taxaColors[i]
        // taxaVizName = taxaVizNames[i]
        var newViz = new carto.Viz(`
            @duration:42,
            @animation: animation($time, @duration, fade(4,6)),
            color: opacity(${taxaColor},0.4)
            strokeColor: opacity(${taxaColor},0.2)
            width: ${taxaColumn}
            filter: @animation
            strokeWidth: ${taxaColumn}/30 * @animation
            order: asc(width())`
        );
        taxaViz[i] = newViz;
        console.log(taxaViz)
    }

      const legendViz = new carto.Viz(`
        width: ramp($legendvalues, [10, 55, 100])
        color: opacity(white, 0)
        strokeWidth: 0
      `);

      const iceViz = new carto.Viz(`
          @duration:42
          @animation: animation($age,@duration, fade(hold,.15))
          color: opacity(#99daf2,1)
          strokeWidth: 0
          filter: @animation
        `);

    for (var i = 0; i < taxaColumns.length; ++i) {
        currentViz = taxaViz[i]
        currentTaxon = toggleableIds[i]
        console.log(currentTaxon)
        var taxaLayer = new carto.Layer(currentTaxon, pollenSource, currentViz);
        taxaLayers[i] = taxaLayer
    }

  const legendLayer = new carto.Layer('legend', pollenSource, legendViz);
  const iceLayer = new carto.Layer('icesheets', iceSource, iceViz);
//   const $progressRange = document.getElementById('js-progress-range');
//   const $playButton = document.getElementById('js-play-button');
//   const $pauseButton = document.getElementById('js-pause-button');
//   const $durationRange = document.getElementById('js-duration-range');
//   const $currentTime = document.getElementById('js-current-time');
//   // Links animations to control elements
//   // Create a listener for every animation layer you build
//   $playButton.addEventListener('click', () => {
//       for (var i = 0; i < taxaColumns.length; ++i) {
//            var currentViz = taxaViz[i]
//            currentViz.variables.animation.play();
//       }
//     iceViz.variables.animation.play();
//   });
//   $pauseButton.addEventListener('click', () => {
//       for (var i = 0; i < taxaColumns.length; ++i) {
//            currentViz = taxaViz[i]
//            currentViz.variables.animation.pause();
//        }
//     // ambrosiaViz.variables.animation.pause();
//     // cyperaceaeViz.variables.animation.pause();
//     // fagusViz.variables.animation.pause();
//     // piceaViz.variables.animation.pause();
//     // pinusViz.variables.animation.pause();
//     // poaceaeViz.variables.animation.pause();
//     // quercusViz.variables.animation.pause();
//     // tsugaViz.variables.animation.pause();
//     // ulmusViz.variables.animation.pause();
//     iceViz.variables.animation.pause();
//   });
//   $durationRange.addEventListener('change', () => {
//     alnusViz.variables.duration = parseInt($durationRange.value, 10);
//     ambrosiaViz.variables.duration = parseInt($durationRange.value, 10);
//     cyperaceaeViz.variables.duration = parseInt($durationRange.value, 10);
//     fagusViz.variables.duration = parseInt($durationRange.value, 10);
//     piceaViz.variables.duration = parseInt($durationRange.value, 10);
//     pinusViz.variables.duration = parseInt($durationRange.value, 10);
//     poaceaeViz.variables.duration = parseInt($durationRange.value, 10);
//     quercusViz.variables.duration = parseInt($durationRange.value, 10);
//     tsugaViz.variables.duration = parseInt($durationRange.value, 10);
//     ulmusViz.variables.duration = parseInt($durationRange.value, 10);
//     iceViz.variables.duration = parseInt($durationRange.value, 10);
//   });
//   $progressRange.addEventListener('change', () => {
//          alnusViz.variables.animation.setProgressPct($progressRange.value);
//          ambrosiaViz.variables.animation.setProgressPct($progressRange.value);
//          cyperaceaeViz.variables.animation.setProgressPct($progressRange.value);
//          fagusViz.variables.animation.setProgressPct($progressRange.value);
//          piceaViz.variables.animation.setProgressPct($progressRange.value);
//          pinusViz.variables.animation.setProgressPct($progressRange.value);
//          poaceaeViz.variables.animation.setProgressPct($progressRange.value);
//          quercusViz.variables.animation.setProgressPct($progressRange.value);
//          tsugaViz.variables.animation.setProgressPct($progressRange.value);
//          ulmusViz.variables.animation.setProgressPct($progressRange.value);
//          iceViz.variables.animation.setProgressPct($progressRange.value);
//      });
//      layer.on('updated', () => {
//      $progressRange.value = alnusViz.variables.animation.getProgressPct();
//      $progressRange.value = ambrosiaViz.variables.animation.getProgressPct();
//      $progressRange.value =cyperaceaeViz.variables.animation.getProgressPct();
//      $progressRange.value = fagusViz.variables.animation.getProgressPct();
//      $progressRange.value =piceaViz.variables.animation.getProgressPct();
//      $progressRange.value =pinusViz.variables.animation.getProgressPct();
//      $progressRange.value =poaceaeViz.variables.animation.getProgressPct();
//      $progressRange.value =quercusViz.variables.animation.getProgressPct();
//      $progressRange.value = tsugaViz.variables.animation.getProgressPct();
//      $progressRange.value = ulmusViz.variables.animation.getProgressPct();
//  });
// //Adds progress bar interactivity
// $progressRange.addEventListener('change', () => {
//     alnusViz.variables.animation.setCurrent($progressRange.value);
//     ambrosiaViz.variables.animation.setCurrent($progressRange.value);
//     cyperaceaeViz.variables.animation.setCurrent($progressRange.value);
//     fagusViz.variables.animation.setCurrent($progressRange.value);
//     piceaViz.variables.animation.setCurrent($progressRange.value);
//     pinusViz.variables.animation.setCurrent($progressRange.value);
//     poaceaeViz.variables.animation.setCurrent($progressRange.value);
//     quercusViz.variables.animation.setCurrent($progressRange.value);
//     tsugaViz.variables.animation.setCurrent($progressRange.value);
//     ulmusViz.variables.animation.setCurrent($progressRange.value);
// });
// //Updates progress bar and current time reader each 100 milliseconds with integer values
//   function updateProgress() {
//     // $progressRange.value = alnusViz.variables.animation.getProgressValue();
//     // $progressRange.value = ambrosiaViz.variables.animation.getProgressValue();
//     // $progressRange.value = cyperaceaeViz.variables.animation.getProgressValue();
//     // $progressRange.value = fagusViz.variables.animation.getProgressValue();
//     // $progressRange.value = piceaViz.variables.animation.getProgressValue();
//     // $progressRange.value = pinusViz.variables.animation.getProgressValue();
//     // $progressRange.value = poaceaeViz.variables.animation.getProgressValue();
//     // $progressRange.value = quercusViz.variables.animation.getProgressValue();
//     // $progressRange.value = tsugaViz.variables.animation.getProgressValue();
//     $progressRange.value = iceViz.variables.animation.getProgressValue();
//     $currentTime.innerText = parseInt(iceViz.variables.animation.getProgressValue());
//     // $currentTime.innerText = parseInt(ambrosiaViz.variables.animation.getProgressValue());
//     // $currentTime.innerText = parseInt(cyperaceaeViz.variables.animation.getProgressValue());
//     // $currentTime.innerText = parseInt(fagusViz.variables.animation.getProgressValue());
//     // $currentTime.innerText = parseInt(piceaViz.variables.animation.getProgressValue());
//     // $currentTime.innerText = parseInt(pinusViz.variables.animation.getProgressValue());
//     // $currentTime.innerText = parseInt(poaceaeViz.variables.animation.getProgressValue());
//     // $currentTime.innerText = parseInt(quercusViz.variables.animation.getProgressValue());
//     // $currentTime.innerText = parseInt(tsugaViz.variables.animation.getProgressValue());
//     // $currentTime.innerText = parseInt(ulmusViz.variables.animation.getProgressValue());
//   }
//
//   layer.on('updated', () => {
//       $progressRange.value = alnusViz.variables.animation.getProgressValue();
//   });
//
//  setInterval(updateProgress, 100);

for (var i = 0; i < taxaColumns.length; ++i) {
    currentLayer = taxaLayers[i];
    currentLayer.addTo(map);
}

  legendLayer.addTo(map);
  iceLayer.addTo(map);
  // When layer loads, trigger legend event
  legendLayer.on('loaded', () => {
      // Request data for legend from the layer viz
      const widthLegend = legendLayer.viz.width.getLegendData({
        samples: 3
      });
      let widthLegendList = '';
      // Create list elements for legend
      widthLegend.data.forEach((legend, index) => {
          widthLegendList +=
              `<li><div class="circle" id="circle${legend.value}" style="width:${legend.value}px; height:${legend.value}px;"></div> ${legend.key.toFixed(0)}</li>`;
      });
      // Place list items in the content section of the title/legend box
      document.getElementById('content').innerHTML = widthLegendList;
  });

  for (var i = 0; i < toggleableIds.length; i++) {
    var id = toggleableIds[i];
    var taxonColor = taxaColors[i];
    var link = document.createElement('taxa');
    link.href = '#';
    link.className = 'active';
    link.textContent = id;
    link.onclick = function(e) {
      var clickedLayer = this.textContent;
      e.preventDefault();
      e.stopPropagation();
      var visibility = map.getLayoutProperty(clickedLayer, 'visibility');
      if (visibility === 'visible') {
        map.setLayoutProperty(clickedLayer, 'visibility', 'none');
        this.className = '';
      } else {
        map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
        this.className = 'active'
      }
    };
    var layers = document.getElementById('menu');
    layers.appendChild(link);
 }


   // var toggleableAlnusIds = ['Alnus', 'Ambrosia'];
   // for (var i = 0; i < toggleableAlnusIds.length; i++) {
   //   var id = toggleableAlnusIds[i];
   //   console.log(id)
   //   var link = document.createElement('Alnus');
   //   link.href = '#';
   //   link.className = 'active';
   //   link.textContent = id;
   //   link.onclick = function(e) {
   //     var clickedLayer = this.textContent;
   //     e.preventDefault();
   //     e.stopPropagation();
   //     var visibility = map.getLayoutProperty(clickedLayer, 'visibility');
   //     if (visibility === 'visible') {
   //       map.setLayoutProperty(clickedLayer, 'visibility', 'none');
   //       this.className = '';
   //     } else {
   //       this.className = 'active';
   //       map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
   //     }
   //   };
   //   var layers = document.getElementById('menu');
   //   layers.appendChild(link);
   // }
   //

   // var toggleableAlnusIds = ['Alnus'];
   // for (var i = 0; i < toggleableAlnusIds.length; i++) {
   //   var id = toggleableAlnusIds[i];
   //   var link = document.createElement('Alnus');
   //   link.href = '#';
   //   link.className = 'active';
   //   link.textContent = id;
   //   link.onclick = function(e) {
   //     var clickedLayer = this.textContent;
   //     e.preventDefault();
   //     e.stopPropagation();
   //     var visibility = map.getLayoutProperty(clickedLayer, 'visibility');
   //     if (visibility === 'visible') {
   //       map.setLayoutProperty(clickedLayer, 'visibility', 'none');
   //       this.className = '';
   //     } else {
   //       this.className = 'active';
   //       map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
   //     }
   //   };
   //   var layers = document.getElementById('menu');
   //   layers.appendChild(link);
   // }

</script>

</body>

</html>
