<!DOCTYPE html>
<html>

<head>
<title>Legend Width | CARTO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<script src="https://libs.cartocdn.com/carto-vl/v1.4.1/carto-vl.min.js"></script>
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js"></script>
<link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css" rel="stylesheet" />
<link href="https://carto.com/developers/carto-vl/examples/maps/style.css" rel="stylesheet">
<style>
  .circle {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 8px;
}
</style>
</head>

<body>
<div id="map"></div>
<aside class="toolbox">
  <div class="box">
      <header>
          <h1>Pollen Abundance</h1>
      </header>
      <!-- Add legend data -->
      <section>
          <div id="controls">
              <ul id="content"></ul>
          </div>
      </section>
  </div>
</aside>

<script>
  const map = new mapboxgl.Map({
      container: 'map',
      style: carto.basemaps.positron,
      center: [-96, 41],
      zoom: 3
  });
  const nav = new mapboxgl.NavigationControl({
      showCompass: false
  });
  map.addControl(nav, 'top-left');
  map.addControl(new mapboxgl.FullscreenControl(), 'top-left');
  carto.setDefaultAuth({
      username: 'widell',
      apiKey: '7de5ebf57ee0f31ed45302fb9c0b3a90723921ae'
  });
  const source = new carto.source.Dataset("cartoinput_na_2");
  const legendViz = new carto.Viz(`
      width: ramp($legendvalues, [10, 25, 50])
      color: opacity(white, 0)
      strokeWidth: 0
  `);

  const alnusViz = new carto.Viz(`
          @duration:42,
          @animation: animation($time, @duration, fade(4,6)),
          color: opacity(#900C3F,0.4)
          strokeColor: opacity(#900C3F,0.6)
          width: $alnus
          filter: @animation
          strokeWidth: $alnus/30 * @animation
          order: asc(width())
      `);

  const legendLayer = new carto.Layer('legend', source, legendViz);
  const alnusLayer = new carto.Layer('Alnus', source, alnusViz);


  legendLayer.addTo(map);
  alnusLayer.addTo(map);
  // When layer loads, trigger legend event
  legendLayer.on('loaded', () => {
      // Request data for legend from the layer viz
      const widthLegend = legendLayer.viz.width.getLegendData({
        samples: 3
      });
      let widthLegendList = '';
      // Create list elements for legend
      widthLegend.data.forEach((legend, index) => {
          widthLegendList +=
              `<li><div class="circle" style="background: #44702f; width:${legend.value}px; height:${legend.value}px;"></div> ${legend.key.toFixed(0)}</li>`;
console.log(widthLegendList)
      });
      // Place list items in the content section of the title/legend box
      document.getElementById('content').innerHTML = widthLegendList;
  });
</script>

</body>

</html>
